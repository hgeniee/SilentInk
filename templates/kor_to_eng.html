<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìˆ˜ì–´ â†’ ì˜ì–´</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .wrapper {
      width: 800px;
      max-width: 90vw;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .video-container {
      position: relative;
      padding-top: 56.25%;
      background: #000;
    }

    .video-container video,
    .video-container canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: contain;
    }

    .result {
      padding: 16px;
      background: #ffffff;
      text-align: center;
      font-size: 1.6rem;
      color: #333;
      border-top: 1px solid #e5e7eb;
    }

    .result span {
      font-weight: bold;
      color: #1f2937;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="video-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="result">
      ì˜ˆì¸¡ ê²°ê³¼: <span id="res">ëŒ€ê¸° ì¤‘...</span><br>
      ë²ˆì—­ ê²°ê³¼(ì˜ì–´): <span id="word">Loading...</span>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const resEl = document.getElementById('res');
    const wordEl = document.getElementById('word');

    let lastSpoken = "";

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          overlay.width = 320;
          overlay.height = 240;
          startLoop();
        };
      });

    async function predictAndDraw() {
      ctx.drawImage(video, 0, 0, overlay.width, overlay.height);
      const dataURL = overlay.toDataURL('image/jpeg', 0.5);

      try {
        const resp = await fetch('/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataURL })
        });

        const { result, frame, type } = await resp.json();

        if (frame) {
          const img = new Image();
          img.onload = () => {
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            ctx.drawImage(img, 0, 0, overlay.width, overlay.height);
          };
          img.src = 'data:image/jpeg;base64,' + frame;
        }

        if (result) {
          if (type === 'char') {
            resEl.innerText = result;
          } else if (type === 'word') {
            resEl.innerText = result;

            if (result !== lastSpoken) {
              lastSpoken = result;

              const encoded = encodeURIComponent(result);
              fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=en&dt=t&q=${encoded}`)
                .then(res => res.json())
                .then(data => {
                  const translated = data?.[0]?.map(item => item?.[0]).join('') || '';
                  if (translated) {
                    wordEl.innerText = translated;
                    speakText(translated);
                  } else {
                    wordEl.innerText = 'ë²ˆì—­ ì‹¤íŒ¨';
                    speakText(result); // fallback
                  }
                })
                .catch(err => {
                  console.error("âŒ ë²ˆì—­ ì‹¤íŒ¨:", err);
                  wordEl.innerText = 'ë²ˆì—­ ì‹¤íŒ¨';
                  speakText(result);
                });
            }
          }
        }
      } catch (err) {
        console.error("âŒ ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
      }
    }

    function startLoop() {
      setInterval(predictAndDraw, 200);
    }

    function speakText(text) {
      if (!window.speechSynthesis) {
        console.warn("ì´ ë¸Œë¼ìš°ì €ëŠ” SpeechSynthesisë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      console.log("ğŸ”ˆ ìŒì„± ì¶œë ¥:", text);

      window.speechSynthesis.cancel(); // ê¸°ì¡´ ë°œí™” ì·¨ì†Œ
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      utter.rate = 1;
      utter.pitch = 1;

      utter.onerror = (e) => {
        console.error("âŒ ìŒì„± ì¶œë ¥ ì˜¤ë¥˜:", e);
      };

      window.speechSynthesis.speak(utter);
    }

    // ë””ë²„ê¹…ìš©: ìŒì„± ëª©ë¡ í™•ì¸
    window.speechSynthesis.onvoiceschanged = () => {
      console.log("ğŸ—£ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:", window.speechSynthesis.getVoices());
    };
  </script>
</body>
</html>

